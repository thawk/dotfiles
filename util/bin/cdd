#!/usr/bin/env bash
# Time: 2020-06-03 16:35:05

if type tmux &> /dev/null
then
    # 如果当前tmux session名称正好是$DOTFILES_SRC_ROOT下的目录名，则进入该目录
    proj_name="$(tmux display-message -p '#S')"
    src_root="${DOTFILES_SRC_ROOT:-$HOME/workspace}"

    if [[ -d "${src_root}/${proj_name}" ]]; then
        cd "${src_root}/${proj_name}"
        return
    fi
fi

# 没有找到与tmux session名称对应的项目，找当前目录往上的VCS目录作为项目的根目录
# 如果有多个VCS目录，说明存在一些子项目，取最顶层目录
last_proj_root=
dir="$PWD"
last_dir=

while [[ "$dir" != "$last_dir" ]]; do
    for d in .git _darcs .hg .bzr .svn; do
        if [[ -e "$dir/$d" ]]; then
            last_proj_root="$dir"
            break
        fi
    done

    last_dir="$dir"
    dir="$(dirname "$dir")"
done

if [[ -d "$last_proj_root" ]]; then
    cd "$last_proj_root"
fi
